### 	节点初始化

- 状态为Follower

- 开启选举定时器

  

  ### 选举定时器 超时

- 加锁

  ```c++
  std::unique_lock<std::mutex> lock(mtx_);
  ```

- 置选举标志为true

  ```election_timeout_ = true;
  election_timeout_ = true;
  ```

- 检查状态必须是Follower

- 如果配置里没有其他节点，变为候选人

- 重置 leader id为空

- 开启(重启) 预投票定时器

- 执行预投票

  - 设置投票计数为1
- 保存当前的term用于收到预投票响应的时候进行比对
  - 填充预投票请求
  - 请求的term为当前term + 1
    - 请求的last_log_idx 为最新的日志索引
    - 请求的last_log_term 为last_log_idx对应的term
    - 请求的from 为 本节点的id
- 执行RPC进行预投票
  

  
- 预投票的响应处理

  - 加锁

    ```c++
    std::unique_lock<std::mutex> lock(mtx_);
    ```

  - 如果状态不是Follower, 放弃处理

  - 发起请求时传入的term和当前term如果不一致，放弃处理

  - 响应的term大于当前term, 执行回退，设置响应的term为当前term

  - 如果响应里为赞成票，投票计数 加一

  - 判断是否收到大多数投票，如果获得多数票，变成Candidate

    
- 预投票定时器超时

  - 不处理

    

- 变成Candidate之后

  - 关闭选举定时器
  - 重置leader_id为空
  - 状态修改为Candidate
  - 当前任期+1
  - 记录已投票的id 为本节点id
  - 开启(重启)投票定时器
  - 开始投票

- 开始投票

  - 投票计数置为1
  - 判断是否获取多数票
  - 保存当前任期用于处理投票响应时进行比对
  - 填充投票请求
    - 请求的任期为当前任期
    - 请求的last_log_idx 为最新的日志索引
    - 请求的last_log_term 为last_log_idx对应的term
    - 请求的from 为 本节点的id
  - 执行RPC进行预投票

- 处理投票响应

  - 加锁

    ```
    std::unique_lock<std::mutex> lock(mtx_);
    ```

  - 如果状态不是Candidate ,放弃处理
  - 如果任期不是当前任期，放弃处理
  - 如果响应里的任期大于当前任期，执行step down
  - 如果响应里的时赞成票，投票计数+1
  - 判断投票是否满足多数票，如果满足，变成leader

- 投票超时

  - 回退到follower
  - 重启选举定时器

- 变成leader 

  - 如果状态不是Candidate, return
  - 状态更改为Leader
  - 设置leader id 为自己的id
  - 启动心跳定时器

